{"version":3,"sources":["../../../../src/core-layers/path-layer/path-layer.js"],"names":["COORDINATE_SYSTEM","Layer","experimental","fp64LowPart","enable64bitSupport","GL","Model","Geometry","vs","vs64","fs","DEFAULT_COLOR","defaultProps","widthScale","widthMinPixels","widthMaxPixels","Number","MAX_SAFE_INTEGER","rounded","miterLimit","fp64","dashJustified","getPath","object","path","getColor","color","getWidth","width","getDashArray","isClosed","firstPoint","lastPoint","length","PathLayer","getShaders","props","modules","initializeState","attributeManager","getAttributeManager","addInstanced","instanceStartPositions","size","update","calculateStartPositions","instanceEndPositions","calculateEndPositions","instanceLeftDeltas","calculateLeftDeltas","instanceRightDeltas","calculateRightDeltas","instanceStrokeWidths","accessor","calculateStrokeWidths","instanceDashArrays","calculateDashArrays","instanceColors","type","UNSIGNED_BYTE","calculateColors","instancePickingColors","calculatePickingColors","updateAttribute","oldProps","changeFlags","invalidateAll","coordinateSystem","LNGLAT","instanceStartEndPositions64xyLow","calculateInstanceStartEndPositions64xyLow","remove","updateState","gl","context","state","model","delete","setState","_getModel","geometryChanged","dataChanged","updateTriggersChanged","all","paths","data","map","numInstances","reduce","count","draw","uniforms","render","Object","assign","jointType","alignMode","SEGMENT_INDICES","SEGMENT_POSITIONS","id","geometry","drawMode","TRIANGLES","attributes","indices","Uint16Array","positions","Float32Array","isInstanced","shaderCache","attribute","value","i","forEach","numSegments","ptIndex","point","startPoint","endPoint","prevPoint","nextPoint","index","dashArray","pointColor","isNaN","pickingColor","encodePickingColor","layerName"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA,SAAQA,iBAAR,EAA2BC,KAA3B,EAAkCC,YAAlC,QAAqD,YAArD;MACOC,W,GAAmCD,Y,CAAnCC,W;MAAaC,kB,GAAsBF,Y,CAAtBE,kB;AACpB,SAAQC,EAAR,EAAYC,KAAZ,EAAmBC,QAAnB,QAAkC,SAAlC;AAEA,OAAOC,EAAP,MAAe,0BAAf;AACA,OAAOC,IAAP,MAAiB,6BAAjB;AACA,OAAOC,EAAP,MAAe,4BAAf;AAEA,MAAMC,gBAAgB,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,GAAV,CAAtB;AAEA,MAAMC,eAAe;AACnBC,cAAY,CADO;AACJ;AACfC,kBAAgB,CAFG;AAEA;AACnBC,kBAAgBC,OAAOC,gBAHJ;AAGsB;AACzCC,WAAS,KAJU;AAKnBC,cAAY,CALO;AAMnBC,QAAM,KANa;AAOnBC,iBAAe,KAPI;AASnBC,WAASC,UAAUA,OAAOC,IATP;AAUnBC,YAAUF,UAAUA,OAAOG,KAAP,IAAgBf,aAVjB;AAWnBgB,YAAUJ,UAAUA,OAAOK,KAAP,IAAgB,CAXjB;AAYnBC,gBAAc;AAZK,CAArB;;AAeA,MAAMC,WAAWN,QAAQ;AACvB,QAAMO,aAAaP,KAAK,CAAL,CAAnB;AACA,QAAMQ,YAAYR,KAAKA,KAAKS,MAAL,GAAc,CAAnB,CAAlB;AACA,SACEF,WAAW,CAAX,MAAkBC,UAAU,CAAV,CAAlB,IACAD,WAAW,CAAX,MAAkBC,UAAU,CAAV,CADlB,IAEAD,WAAW,CAAX,MAAkBC,UAAU,CAAV,CAHpB;AAKD,CARD;;AAUA,eAAe,MAAME,SAAN,SAAwBjC,KAAxB,CAA8B;AAC3CkC,eAAa;AACX,WAAO/B,mBAAmB,KAAKgC,KAAxB,IACH;AAAC5B,UAAIC,IAAL;AAAWC,QAAX;AAAe2B,eAAS,CAAC,WAAD,EAAc,SAAd;AAAxB,KADG,GAEH;AAAC7B,QAAD;AAAKE,QAAL;AAAS2B,eAAS,CAAC,SAAD;AAAlB,KAFJ,CADW,CAGyB;AACrC;;AAEDC,oBAAkB;AAChB,UAAMC,mBAAmB,KAAKC,mBAAL,EAAzB;AACA;;AACAD,qBAAiBE,YAAjB,CAA8B;AAC5BC,8BAAwB;AAACC,cAAM,CAAP;AAAUC,gBAAQ,KAAKC;AAAvB,OADI;AAE5BC,4BAAsB;AAACH,cAAM,CAAP;AAAUC,gBAAQ,KAAKG;AAAvB,OAFM;AAG5BC,0BAAoB;AAACL,cAAM,CAAP;AAAUC,gBAAQ,KAAKK;AAAvB,OAHQ;AAI5BC,2BAAqB;AAACP,cAAM,CAAP;AAAUC,gBAAQ,KAAKO;AAAvB,OAJO;AAK5BC,4BAAsB;AAACT,cAAM,CAAP;AAAUU,kBAAU,UAApB;AAAgCT,gBAAQ,KAAKU;AAA7C,OALM;AAM5BC,0BAAoB;AAACZ,cAAM,CAAP;AAAUU,kBAAU,cAApB;AAAoCT,gBAAQ,KAAKY;AAAjD,OANQ;AAO5BC,sBAAgB;AACdd,cAAM,CADQ;AAEde,cAAMrD,GAAGsD,aAFK;AAGdN,kBAAU,UAHI;AAIdT,gBAAQ,KAAKgB;AAJC,OAPY;AAa5BC,6BAAuB;AAAClB,cAAM,CAAP;AAAUe,cAAMrD,GAAGsD,aAAnB;AAAkCf,gBAAQ,KAAKkB;AAA/C;AAbK,KAA9B;AAeA;AACD;;AAEDC,kBAAgB;AAAC3B,SAAD;AAAQ4B,YAAR;AAAkBC;AAAlB,GAAhB,EAAgD;AAC9C,QAAI7B,MAAMhB,IAAN,KAAe4C,SAAS5C,IAA5B,EAAkC;AAChC,YAAMmB,mBAAmB,KAAKC,mBAAL,EAAzB;AACAD,uBAAiB2B,aAAjB;;AAEA,UAAI9B,MAAMhB,IAAN,IAAcgB,MAAM+B,gBAAN,KAA2BnE,kBAAkBoE,MAA/D,EAAuE;AACrE7B,yBAAiBE,YAAjB,CAA8B;AAC5B4B,4CAAkC;AAChC1B,kBAAM,CAD0B;AAEhCC,oBAAQ,KAAK0B;AAFmB;AADN,SAA9B;AAMD,OAPD,MAOO;AACL/B,yBAAiBgC,MAAjB,CAAwB,CAAC,kCAAD,CAAxB;AACD;AACF;AACF;;AAEDC,cAAY;AAACR,YAAD;AAAW5B,SAAX;AAAkB6B;AAAlB,GAAZ,EAA4C;AAC1C,UAAMO,WAAN,CAAkB;AAACpC,WAAD;AAAQ4B,cAAR;AAAkBC;AAAlB,KAAlB;AAD0C,UAGnC3C,OAHmC,GAGxB,KAAKc,KAHmB,CAGnCd,OAHmC;AAI1C,UAAMiB,mBAAmB,KAAKC,mBAAL,EAAzB;;AACA,QAAIJ,MAAMhB,IAAN,KAAe4C,SAAS5C,IAA5B,EAAkC;AAAA,YACzBqD,EADyB,GACnB,KAAKC,OADc,CACzBD,EADyB;;AAEhC,UAAI,KAAKE,KAAL,CAAWC,KAAf,EAAsB;AACpB,aAAKD,KAAL,CAAWC,KAAX,CAAiBC,MAAjB;AACD;;AACD,WAAKC,QAAL,CAAc;AAACF,eAAO,KAAKG,SAAL,CAAeN,EAAf;AAAR,OAAd;AACD;;AACD,SAAKV,eAAL,CAAqB;AAAC3B,WAAD;AAAQ4B,cAAR;AAAkBC;AAAlB,KAArB;AAEA,UAAMe,kBACJf,YAAYgB,WAAZ,IACChB,YAAYiB,qBAAZ,KACEjB,YAAYiB,qBAAZ,CAAkCC,GAAlC,IAAyClB,YAAYiB,qBAAZ,CAAkC5D,OAD7E,CAFH;;AAKA,QAAI0D,eAAJ,EAAqB;AACnB;AACA,YAAMI,QAAQhD,MAAMiD,IAAN,CAAWC,GAAX,CAAehE,OAAf,CAAd;AACA,YAAMiE,eAAeH,MAAMI,MAAN,CAAa,CAACC,KAAD,EAAQjE,IAAR,KAAiBiE,QAAQjE,KAAKS,MAAb,GAAsB,CAApD,EAAuD,CAAvD,CAArB;AAEA,WAAK6C,QAAL,CAAc;AAACM,aAAD;AAAQG;AAAR,OAAd;AACAhD,uBAAiB2B,aAAjB;AACD;AACF;;AAEDwB,OAAK;AAACC;AAAD,GAAL,EAAiB;AAAA,mBAQX,KAAKvD,KARM;AAAA,UAEblB,OAFa,UAEbA,OAFa;AAAA,UAGbC,UAHa,UAGbA,UAHa;AAAA,UAIbN,UAJa,UAIbA,UAJa;AAAA,UAKbC,cALa,UAKbA,cALa;AAAA,UAMbC,cANa,UAMbA,cANa;AAAA,UAObM,aAPa,UAObA,aAPa;AAUf,SAAKsD,KAAL,CAAWC,KAAX,CAAiBgB,MAAjB,CACEC,OAAOC,MAAP,CAAc,EAAd,EAAkBH,QAAlB,EAA4B;AAC1BI,iBAAW/E,OAAOE,OAAP,CADe;AAE1B8E,iBAAWhF,OAAOK,aAAP,CAFe;AAG1BR,gBAH0B;AAI1BM,gBAJ0B;AAK1BL,oBAL0B;AAM1BC;AAN0B,KAA5B,CADF;AAUD;;AAEDgE,YAAUN,EAAV,EAAc;AACZ;;;;;;;;;;;;;;AAeA,UAAMwB,kBAAkB,CACtB;AACA,KAFsB,EAGtB,CAHsB,EAItB,CAJsB,EAKtB;AACA,KANsB,EAOtB,CAPsB,EAQtB,CARsB,EAStB,CATsB,EAUtB,CAVsB,EAWtB,CAXsB,EAYtB;AACA,KAbsB,EActB,CAdsB,EAetB,CAfsB,CAAxB,CAhBY,CAkCZ;AACA;AACA;;AACA,UAAMC,oBAAoB,CACxB;AACA,KAFwB,EAGxB,CAHwB,EAIxB,CAJwB,EAKxB;AACA,KANwB,EAOxB,CAAC,CAPuB,EAQxB,CARwB,EASxB;AACA,KAVwB,EAWxB,CAXwB,EAYxB,CAZwB,EAaxB;AACA,KAdwB,EAexB,CAAC,CAfuB,EAgBxB,CAhBwB,EAiBxB;AACA,KAlBwB,EAmBxB,CAnBwB,EAoBxB,CApBwB,EAqBxB;AACA,KAtBwB,EAuBxB,CAvBwB,EAwBxB,CAxBwB,CAA1B;AA2BA,WAAO,IAAI5F,KAAJ,CACLmE,EADK,EAELoB,OAAOC,MAAP,CAAc,EAAd,EAAkB,KAAK3D,UAAL,EAAlB,EAAqC;AACnCgE,UAAI,KAAK/D,KAAL,CAAW+D,EADoB;AAEnCC,gBAAU,IAAI7F,QAAJ,CAAa;AACrB8F,kBAAUhG,GAAGiG,SADQ;AAErBC,oBAAY;AACVC,mBAAS,IAAIC,WAAJ,CAAgBR,eAAhB,CADC;AAEVS,qBAAW,IAAIC,YAAJ,CAAiBT,iBAAjB;AAFD;AAFS,OAAb,CAFyB;AASnCU,mBAAa,IATsB;AAUnCC,mBAAa,KAAKnC,OAAL,CAAamC;AAVS,KAArC,CAFK,CAAP;AAeD;;AAEDhE,0BAAwBiE,SAAxB,EAAmC;AAAA,UAC1B1B,KAD0B,GACjB,KAAKT,KADY,CAC1BS,KAD0B;AAAA,UAE1B2B,KAF0B,GAEjBD,SAFiB,CAE1BC,KAF0B;AAIjC,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAczF,QAAQ;AACpB,YAAM0F,cAAc1F,KAAKS,MAAL,GAAc,CAAlC;;AACA,WAAK,IAAIkF,UAAU,CAAnB,EAAsBA,UAAUD,WAAhC,EAA6CC,SAA7C,EAAwD;AACtD,cAAMC,QAAQ5F,KAAK2F,OAAL,CAAd;AACAJ,cAAMC,GAAN,IAAaI,MAAM,CAAN,CAAb;AACAL,cAAMC,GAAN,IAAaI,MAAM,CAAN,CAAb;AACAL,cAAMC,GAAN,IAAaI,MAAM,CAAN,KAAY,CAAzB;AACD;AACF,KARD;AASD;;AAEDrE,wBAAsB+D,SAAtB,EAAiC;AAAA,UACxB1B,KADwB,GACf,KAAKT,KADU,CACxBS,KADwB;AAAA,UAExB2B,KAFwB,GAEfD,SAFe,CAExBC,KAFwB;AAI/B,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAczF,QAAQ;AACpB,WAAK,IAAI2F,UAAU,CAAnB,EAAsBA,UAAU3F,KAAKS,MAArC,EAA6CkF,SAA7C,EAAwD;AACtD,cAAMC,QAAQ5F,KAAK2F,OAAL,CAAd;AACAJ,cAAMC,GAAN,IAAaI,MAAM,CAAN,CAAb;AACAL,cAAMC,GAAN,IAAaI,MAAM,CAAN,CAAb;AACAL,cAAMC,GAAN,IAAaI,MAAM,CAAN,KAAY,CAAzB;AACD;AACF,KAPD;AAQD;;AAED9C,4CAA0CwC,SAA1C,EAAqD;AAAA,UAC5C1B,KAD4C,GACnC,KAAKT,KAD8B,CAC5CS,KAD4C;AAAA,UAE5C2B,KAF4C,GAEnCD,SAFmC,CAE5CC,KAF4C;AAInD,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAczF,QAAQ;AACpB,YAAM0F,cAAc1F,KAAKS,MAAL,GAAc,CAAlC;;AACA,WAAK,IAAIkF,UAAU,CAAnB,EAAsBA,UAAUD,WAAhC,EAA6CC,SAA7C,EAAwD;AACtD,cAAME,aAAa7F,KAAK2F,OAAL,CAAnB;AACA,cAAMG,WAAW9F,KAAK2F,UAAU,CAAf,CAAjB;AACAJ,cAAMC,GAAN,IAAa7G,YAAYkH,WAAW,CAAX,CAAZ,CAAb;AACAN,cAAMC,GAAN,IAAa7G,YAAYkH,WAAW,CAAX,CAAZ,CAAb;AACAN,cAAMC,GAAN,IAAa7G,YAAYmH,SAAS,CAAT,CAAZ,CAAb;AACAP,cAAMC,GAAN,IAAa7G,YAAYmH,SAAS,CAAT,CAAZ,CAAb;AACD;AACF,KAVD;AAWD;;AAEDrE,sBAAoB6D,SAApB,EAA+B;AAAA,UACtB1B,KADsB,GACb,KAAKT,KADQ,CACtBS,KADsB;AAAA,UAEtB2B,KAFsB,GAEbD,SAFa,CAEtBC,KAFsB;AAI7B,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAczF,QAAQ;AACpB,YAAM0F,cAAc1F,KAAKS,MAAL,GAAc,CAAlC;AACA,UAAIsF,YAAYzF,SAASN,IAAT,IAAiBA,KAAKA,KAAKS,MAAL,GAAc,CAAnB,CAAjB,GAAyCT,KAAK,CAAL,CAAzD;;AAEA,WAAK,IAAI2F,UAAU,CAAnB,EAAsBA,UAAUD,WAAhC,EAA6CC,SAA7C,EAAwD;AACtD,cAAMC,QAAQ5F,KAAK2F,OAAL,CAAd;AACAJ,cAAMC,GAAN,IAAaI,MAAM,CAAN,IAAWG,UAAU,CAAV,CAAxB;AACAR,cAAMC,GAAN,IAAaI,MAAM,CAAN,IAAWG,UAAU,CAAV,CAAxB;AACAR,cAAMC,GAAN,IAAaI,MAAM,CAAN,IAAWG,UAAU,CAAV,CAAX,IAA2B,CAAxC;AACAA,oBAAYH,KAAZ;AACD;AACF,KAXD;AAYD;;AAEDjE,uBAAqB2D,SAArB,EAAgC;AAAA,UACvB1B,KADuB,GACd,KAAKT,KADS,CACvBS,KADuB;AAAA,UAEvB2B,KAFuB,GAEdD,SAFc,CAEvBC,KAFuB;AAI9B,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAczF,QAAQ;AACpB,WAAK,IAAI2F,UAAU,CAAnB,EAAsBA,UAAU3F,KAAKS,MAArC,EAA6CkF,SAA7C,EAAwD;AACtD,cAAMC,QAAQ5F,KAAK2F,OAAL,CAAd;AACA,YAAIK,YAAYhG,KAAK2F,UAAU,CAAf,CAAhB;;AACA,YAAI,CAACK,SAAL,EAAgB;AACdA,sBAAY1F,SAASN,IAAT,IAAiBA,KAAK,CAAL,CAAjB,GAA2B4F,KAAvC;AACD;;AAEDL,cAAMC,GAAN,IAAaQ,UAAU,CAAV,IAAeJ,MAAM,CAAN,CAA5B;AACAL,cAAMC,GAAN,IAAaQ,UAAU,CAAV,IAAeJ,MAAM,CAAN,CAA5B;AACAL,cAAMC,GAAN,IAAaQ,UAAU,CAAV,IAAeJ,MAAM,CAAN,CAAf,IAA2B,CAAxC;AACD;AACF,KAZD;AAaD;;AAED9D,wBAAsBwD,SAAtB,EAAiC;AAAA,oBACN,KAAK1E,KADC;AAAA,UACxBiD,IADwB,WACxBA,IADwB;AAAA,UAClB1D,QADkB,WAClBA,QADkB;AAAA,UAExByD,KAFwB,GAEf,KAAKT,KAFU,CAExBS,KAFwB;AAAA,UAGxB2B,KAHwB,GAGfD,SAHe,CAGxBC,KAHwB;AAK/B,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAc,CAACzF,IAAD,EAAOiG,KAAP,KAAiB;AAC7B,YAAM7F,QAAQD,SAAS0D,KAAKoC,KAAL,CAAT,EAAsBA,KAAtB,CAAd;;AACA,WAAK,IAAIN,UAAU,CAAnB,EAAsBA,UAAU3F,KAAKS,MAArC,EAA6CkF,SAA7C,EAAwD;AACtDJ,cAAMC,GAAN,IAAapF,KAAb;AACD;AACF,KALD;AAMD;;AAED4B,sBAAoBsD,SAApB,EAA+B;AAAA,oBACA,KAAK1E,KADL;AAAA,UACtBiD,IADsB,WACtBA,IADsB;AAAA,UAChBxD,YADgB,WAChBA,YADgB;;AAE7B,QAAI,CAACA,YAAL,EAAmB;AACjB;AACD;;AAJ4B,UAMtBuD,KANsB,GAMb,KAAKT,KANQ,CAMtBS,KANsB;AAAA,UAOtB2B,KAPsB,GAObD,SAPa,CAOtBC,KAPsB;AAQ7B,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAc,CAACzF,IAAD,EAAOiG,KAAP,KAAiB;AAC7B,YAAMC,YAAY7F,aAAawD,KAAKoC,KAAL,CAAb,EAA0BA,KAA1B,CAAlB;;AACA,WAAK,IAAIN,UAAU,CAAnB,EAAsBA,UAAU3F,KAAKS,MAArC,EAA6CkF,SAA7C,EAAwD;AACtDJ,cAAMC,GAAN,IAAaU,UAAU,CAAV,CAAb;AACAX,cAAMC,GAAN,IAAaU,UAAU,CAAV,CAAb;AACD;AACF,KAND;AAOD;;AAED9D,kBAAgBkD,SAAhB,EAA2B;AAAA,oBACA,KAAK1E,KADL;AAAA,UAClBiD,IADkB,WAClBA,IADkB;AAAA,UACZ5D,QADY,WACZA,QADY;AAAA,UAElB2D,KAFkB,GAET,KAAKT,KAFI,CAElBS,KAFkB;AAAA,UAGlB2B,KAHkB,GAGTD,SAHS,CAGlBC,KAHkB;AAKzB,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAc,CAACzF,IAAD,EAAOiG,KAAP,KAAiB;AAC7B,YAAME,aAAalG,SAAS4D,KAAKoC,KAAL,CAAT,EAAsBA,KAAtB,CAAnB;;AACA,UAAIG,MAAMD,WAAW,CAAX,CAAN,CAAJ,EAA0B;AACxBA,mBAAW,CAAX,IAAgB,GAAhB;AACD;;AACD,WAAK,IAAIR,UAAU,CAAnB,EAAsBA,UAAU3F,KAAKS,MAArC,EAA6CkF,SAA7C,EAAwD;AACtDJ,cAAMC,GAAN,IAAaW,WAAW,CAAX,CAAb;AACAZ,cAAMC,GAAN,IAAaW,WAAW,CAAX,CAAb;AACAZ,cAAMC,GAAN,IAAaW,WAAW,CAAX,CAAb;AACAZ,cAAMC,GAAN,IAAaW,WAAW,CAAX,CAAb;AACD;AACF,KAXD;AAYD,GA5T0C,CA8T3C;;;AACA7D,yBAAuBgD,SAAvB,EAAkC;AAAA,UACzB1B,KADyB,GAChB,KAAKT,KADW,CACzBS,KADyB;AAAA,UAEzB2B,KAFyB,GAEhBD,SAFgB,CAEzBC,KAFyB;AAIhC,QAAIC,IAAI,CAAR;AACA5B,UAAM6B,OAAN,CAAc,CAACzF,IAAD,EAAOiG,KAAP,KAAiB;AAC7B,YAAMI,eAAe,KAAKC,kBAAL,CAAwBL,KAAxB,CAArB;;AACA,WAAK,IAAIN,UAAU,CAAnB,EAAsBA,UAAU3F,KAAKS,MAArC,EAA6CkF,SAA7C,EAAwD;AACtDJ,cAAMC,GAAN,IAAaa,aAAa,CAAb,CAAb;AACAd,cAAMC,GAAN,IAAaa,aAAa,CAAb,CAAb;AACAd,cAAMC,GAAN,IAAaa,aAAa,CAAb,CAAb;AACD;AACF,KAPD;AAQD;;AA5U0C;AA+U7C3F,UAAU6F,SAAV,GAAsB,WAAtB;AACA7F,UAAUtB,YAAV,GAAyBA,YAAzB","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {COORDINATE_SYSTEM, Layer, experimental} from '../../core';\nconst {fp64LowPart, enable64bitSupport} = experimental;\nimport {GL, Model, Geometry} from 'luma.gl';\n\nimport vs from './path-layer-vertex.glsl';\nimport vs64 from './path-layer-vertex-64.glsl';\nimport fs from './path-layer-fragment.glsl';\n\nconst DEFAULT_COLOR = [0, 0, 0, 255];\n\nconst defaultProps = {\n  widthScale: 1, // stroke width in meters\n  widthMinPixels: 0, //  min stroke width in pixels\n  widthMaxPixels: Number.MAX_SAFE_INTEGER, // max stroke width in pixels\n  rounded: false,\n  miterLimit: 4,\n  fp64: false,\n  dashJustified: false,\n\n  getPath: object => object.path,\n  getColor: object => object.color || DEFAULT_COLOR,\n  getWidth: object => object.width || 1,\n  getDashArray: null\n};\n\nconst isClosed = path => {\n  const firstPoint = path[0];\n  const lastPoint = path[path.length - 1];\n  return (\n    firstPoint[0] === lastPoint[0] &&\n    firstPoint[1] === lastPoint[1] &&\n    firstPoint[2] === lastPoint[2]\n  );\n};\n\nexport default class PathLayer extends Layer {\n  getShaders() {\n    return enable64bitSupport(this.props)\n      ? {vs: vs64, fs, modules: ['project64', 'picking']}\n      : {vs, fs, modules: ['picking']}; // 'project' module added by default.\n  }\n\n  initializeState() {\n    const attributeManager = this.getAttributeManager();\n    /* eslint-disable max-len */\n    attributeManager.addInstanced({\n      instanceStartPositions: {size: 3, update: this.calculateStartPositions},\n      instanceEndPositions: {size: 3, update: this.calculateEndPositions},\n      instanceLeftDeltas: {size: 3, update: this.calculateLeftDeltas},\n      instanceRightDeltas: {size: 3, update: this.calculateRightDeltas},\n      instanceStrokeWidths: {size: 1, accessor: 'getWidth', update: this.calculateStrokeWidths},\n      instanceDashArrays: {size: 2, accessor: 'getDashArray', update: this.calculateDashArrays},\n      instanceColors: {\n        size: 4,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getColor',\n        update: this.calculateColors\n      },\n      instancePickingColors: {size: 3, type: GL.UNSIGNED_BYTE, update: this.calculatePickingColors}\n    });\n    /* eslint-enable max-len */\n  }\n\n  updateAttribute({props, oldProps, changeFlags}) {\n    if (props.fp64 !== oldProps.fp64) {\n      const attributeManager = this.getAttributeManager();\n      attributeManager.invalidateAll();\n\n      if (props.fp64 && props.coordinateSystem === COORDINATE_SYSTEM.LNGLAT) {\n        attributeManager.addInstanced({\n          instanceStartEndPositions64xyLow: {\n            size: 4,\n            update: this.calculateInstanceStartEndPositions64xyLow\n          }\n        });\n      } else {\n        attributeManager.remove(['instanceStartEndPositions64xyLow']);\n      }\n    }\n  }\n\n  updateState({oldProps, props, changeFlags}) {\n    super.updateState({props, oldProps, changeFlags});\n\n    const {getPath} = this.props;\n    const attributeManager = this.getAttributeManager();\n    if (props.fp64 !== oldProps.fp64) {\n      const {gl} = this.context;\n      if (this.state.model) {\n        this.state.model.delete();\n      }\n      this.setState({model: this._getModel(gl)});\n    }\n    this.updateAttribute({props, oldProps, changeFlags});\n\n    const geometryChanged =\n      changeFlags.dataChanged ||\n      (changeFlags.updateTriggersChanged &&\n        (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getPath));\n\n    if (geometryChanged) {\n      // this.state.paths only stores point positions in each path\n      const paths = props.data.map(getPath);\n      const numInstances = paths.reduce((count, path) => count + path.length - 1, 0);\n\n      this.setState({paths, numInstances});\n      attributeManager.invalidateAll();\n    }\n  }\n\n  draw({uniforms}) {\n    const {\n      rounded,\n      miterLimit,\n      widthScale,\n      widthMinPixels,\n      widthMaxPixels,\n      dashJustified\n    } = this.props;\n\n    this.state.model.render(\n      Object.assign({}, uniforms, {\n        jointType: Number(rounded),\n        alignMode: Number(dashJustified),\n        widthScale,\n        miterLimit,\n        widthMinPixels,\n        widthMaxPixels\n      })\n    );\n  }\n\n  _getModel(gl) {\n    /*\n     *       _\n     *        \"-_ 1                   3                       5\n     *     _     \"o---------------------o-------------------_-o\n     *       -   / \"\"--..__              '.             _.-' /\n     *   _     \"@- - - - - \"\"--..__- - - - x - - - -_.@'    /\n     *    \"-_  /                   \"\"--..__ '.  _,-` :     /\n     *       \"o----------------------------\"\"-o'    :     /\n     *      0,2                            4 / '.  :     /\n     *                                      /   '.:     /\n     *                                     /     :'.   /\n     *                                    /     :  ', /\n     *                                   /     :     o\n     */\n\n    const SEGMENT_INDICES = [\n      // start corner\n      0,\n      2,\n      1,\n      // body\n      1,\n      2,\n      4,\n      1,\n      4,\n      3,\n      // end corner\n      3,\n      4,\n      5\n    ];\n\n    // [0] position on segment - 0: start, 1: end\n    // [1] side of path - -1: left, 0: center, 1: right\n    // [2] role - 0: offset point 1: joint point\n    const SEGMENT_POSITIONS = [\n      // bevel start corner\n      0,\n      0,\n      1,\n      // start inner corner\n      0,\n      -1,\n      0,\n      // start outer corner\n      0,\n      1,\n      0,\n      // end inner corner\n      1,\n      -1,\n      0,\n      // end outer corner\n      1,\n      1,\n      0,\n      // bevel end corner\n      1,\n      0,\n      1\n    ];\n\n    return new Model(\n      gl,\n      Object.assign({}, this.getShaders(), {\n        id: this.props.id,\n        geometry: new Geometry({\n          drawMode: GL.TRIANGLES,\n          attributes: {\n            indices: new Uint16Array(SEGMENT_INDICES),\n            positions: new Float32Array(SEGMENT_POSITIONS)\n          }\n        }),\n        isInstanced: true,\n        shaderCache: this.context.shaderCache\n      })\n    );\n  }\n\n  calculateStartPositions(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      const numSegments = path.length - 1;\n      for (let ptIndex = 0; ptIndex < numSegments; ptIndex++) {\n        const point = path[ptIndex];\n        value[i++] = point[0];\n        value[i++] = point[1];\n        value[i++] = point[2] || 0;\n      }\n    });\n  }\n\n  calculateEndPositions(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        const point = path[ptIndex];\n        value[i++] = point[0];\n        value[i++] = point[1];\n        value[i++] = point[2] || 0;\n      }\n    });\n  }\n\n  calculateInstanceStartEndPositions64xyLow(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      const numSegments = path.length - 1;\n      for (let ptIndex = 0; ptIndex < numSegments; ptIndex++) {\n        const startPoint = path[ptIndex];\n        const endPoint = path[ptIndex + 1];\n        value[i++] = fp64LowPart(startPoint[0]);\n        value[i++] = fp64LowPart(startPoint[1]);\n        value[i++] = fp64LowPart(endPoint[0]);\n        value[i++] = fp64LowPart(endPoint[1]);\n      }\n    });\n  }\n\n  calculateLeftDeltas(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      const numSegments = path.length - 1;\n      let prevPoint = isClosed(path) ? path[path.length - 2] : path[0];\n\n      for (let ptIndex = 0; ptIndex < numSegments; ptIndex++) {\n        const point = path[ptIndex];\n        value[i++] = point[0] - prevPoint[0];\n        value[i++] = point[1] - prevPoint[1];\n        value[i++] = point[2] - prevPoint[2] || 0;\n        prevPoint = point;\n      }\n    });\n  }\n\n  calculateRightDeltas(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach(path => {\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        const point = path[ptIndex];\n        let nextPoint = path[ptIndex + 1];\n        if (!nextPoint) {\n          nextPoint = isClosed(path) ? path[1] : point;\n        }\n\n        value[i++] = nextPoint[0] - point[0];\n        value[i++] = nextPoint[1] - point[1];\n        value[i++] = nextPoint[2] - point[2] || 0;\n      }\n    });\n  }\n\n  calculateStrokeWidths(attribute) {\n    const {data, getWidth} = this.props;\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach((path, index) => {\n      const width = getWidth(data[index], index);\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        value[i++] = width;\n      }\n    });\n  }\n\n  calculateDashArrays(attribute) {\n    const {data, getDashArray} = this.props;\n    if (!getDashArray) {\n      return;\n    }\n\n    const {paths} = this.state;\n    const {value} = attribute;\n    let i = 0;\n    paths.forEach((path, index) => {\n      const dashArray = getDashArray(data[index], index);\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        value[i++] = dashArray[0];\n        value[i++] = dashArray[1];\n      }\n    });\n  }\n\n  calculateColors(attribute) {\n    const {data, getColor} = this.props;\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach((path, index) => {\n      const pointColor = getColor(data[index], index);\n      if (isNaN(pointColor[3])) {\n        pointColor[3] = 255;\n      }\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        value[i++] = pointColor[0];\n        value[i++] = pointColor[1];\n        value[i++] = pointColor[2];\n        value[i++] = pointColor[3];\n      }\n    });\n  }\n\n  // Override the default picking colors calculation\n  calculatePickingColors(attribute) {\n    const {paths} = this.state;\n    const {value} = attribute;\n\n    let i = 0;\n    paths.forEach((path, index) => {\n      const pickingColor = this.encodePickingColor(index);\n      for (let ptIndex = 1; ptIndex < path.length; ptIndex++) {\n        value[i++] = pickingColor[0];\n        value[i++] = pickingColor[1];\n        value[i++] = pickingColor[2];\n      }\n    });\n  }\n}\n\nPathLayer.layerName = 'PathLayer';\nPathLayer.defaultProps = defaultProps;\n"],"file":"path-layer.js"}