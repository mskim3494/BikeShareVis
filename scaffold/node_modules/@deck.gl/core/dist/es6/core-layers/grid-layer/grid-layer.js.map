{"version":3,"sources":["../../../../src/core-layers/grid-layer/grid-layer.js"],"names":["CompositeLayer","experimental","BinSorter","defaultColorRange","getQuantizeScale","getLinearScale","GridCellLayer","pointToDensityGridData","nop","defaultProps","colorDomain","colorRange","getColorValue","points","length","lowerPercentile","type","min","max","value","upperPercentile","onSetColorDomain","elevationDomain","elevationRange","getElevationValue","elevationLowerPercentile","elevationUpperPercentile","elevationScale","onSetElevationDomain","cellSize","coverage","getPosition","x","position","extruded","fp64","lightSettings","GridLayer","initializeState","state","layerData","sortedColorBins","sortedElevationBins","colorValueDomain","elevationValueDomain","colorScaleFunc","elevationScaleFunc","dimensionUpdaters","getDimensionUpdaters","updateState","oldProps","props","changeFlags","dimensionChanges","getDimensionChanges","dataChanged","needsReProjectPoints","getLayerData","forEach","f","apply","getColor","id","triggers","updater","getSortedColorBins","getColorValueDomain","getColorScale","getElevation","getSortedElevationBins","getElevationValueDomain","getElevationScale","updaters","dimensionKey","needUpdate","find","item","some","t","push","getPickingInfo","info","isPicked","picked","index","object","cell","colorValue","binMap","elevationValue","Object","assign","Boolean","getUpdateTriggers","updateTriggers","step","prop","data","setState","getSortedBins","getValueDomain","getValueRange","_onGetSublayerColor","cv","isColorValueInDomain","color","Number","isFinite","_onGetSublayerElevation","ev","isElevationValueInDomain","getSubLayerProps","bind","getSubLayerClass","renderLayers","SubLayerClass","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {CompositeLayer, experimental} from '../../core';\nconst {BinSorter, defaultColorRange, getQuantizeScale, getLinearScale} = experimental;\n\nimport GridCellLayer from '../grid-cell-layer/grid-cell-layer';\n\nimport {pointToDensityGridData} from './grid-aggregator';\n\nfunction nop() {}\n\nconst defaultProps = {\n  // color\n  colorDomain: null,\n  colorRange: defaultColorRange,\n  getColorValue: points => points.length,\n  lowerPercentile: {type: 'number', min: 0, max: 100, value: 0},\n  upperPercentile: {type: 'number', min: 0, max: 100, value: 100},\n  onSetColorDomain: nop,\n\n  // elevation\n  elevationDomain: null,\n  elevationRange: [0, 1000],\n  getElevationValue: points => points.length,\n  elevationLowerPercentile: {type: 'number', min: 0, max: 100, value: 0},\n  elevationUpperPercentile: {type: 'number', min: 0, max: 100, value: 100},\n  elevationScale: 1,\n  onSetElevationDomain: nop,\n\n  // grid\n  cellSize: {type: 'number', min: 0, max: 1000, value: 1000},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  getPosition: x => x.position,\n  extruded: false,\n  fp64: false,\n\n  // Optional settings for 'lighting' shader module\n  lightSettings: {}\n};\n\nexport default class GridLayer extends CompositeLayer {\n  initializeState() {\n    this.state = {\n      layerData: [],\n      sortedColorBins: null,\n      sortedElevationBins: null,\n      colorValueDomain: null,\n      elevationValueDomain: null,\n      colorScaleFunc: nop,\n      elevationScaleFunc: nop,\n      dimensionUpdaters: this.getDimensionUpdaters()\n    };\n  }\n\n  updateState({oldProps, props, changeFlags}) {\n    const dimensionChanges = this.getDimensionChanges(oldProps, props);\n\n    if (changeFlags.dataChanged || this.needsReProjectPoints(oldProps, props)) {\n      // project data into hexagons, and get sortedBins\n      this.getLayerData();\n    } else if (dimensionChanges) {\n      dimensionChanges.forEach(f => typeof f === 'function' && f.apply(this));\n    }\n  }\n\n  needsReProjectPoints(oldProps, props) {\n    return oldProps.cellSize !== props.cellSize;\n  }\n\n  getDimensionUpdaters() {\n    // dimension updaters are sequential,\n    // if the first one needs to be called, the 2nd and 3rd one will automatically\n    // be called. e.g. if ColorValue needs to be updated, getColorValueDomain and getColorScale\n    // will automatically be called\n    return {\n      getColor: [\n        {\n          id: 'value',\n          triggers: ['getColorValue'],\n          updater: this.getSortedColorBins\n        },\n        {\n          id: 'domain',\n          triggers: ['lowerPercentile', 'upperPercentile'],\n          updater: this.getColorValueDomain\n        },\n        {\n          id: 'scaleFunc',\n          triggers: ['colorDomain', 'colorRange'],\n          updater: this.getColorScale\n        }\n      ],\n      getElevation: [\n        {\n          id: 'value',\n          triggers: ['getElevationValue'],\n          updater: this.getSortedElevationBins\n        },\n        {\n          id: 'domain',\n          triggers: ['elevationLowerPercentile', 'elevationUpperPercentile'],\n          updater: this.getElevationValueDomain\n        },\n        {\n          id: 'scaleFunc',\n          triggers: ['elevationDomain', 'elevationRange'],\n          updater: this.getElevationScale\n        }\n      ]\n    };\n  }\n\n  getDimensionChanges(oldProps, props) {\n    const {dimensionUpdaters} = this.state;\n    const updaters = [];\n\n    // get dimension to be updated\n    for (const dimensionKey in dimensionUpdaters) {\n      // return the first triggered updater for each dimension\n      const needUpdate = dimensionUpdaters[dimensionKey].find(item =>\n        item.triggers.some(t => oldProps[t] !== props[t])\n      );\n\n      if (needUpdate) {\n        updaters.push(needUpdate.updater);\n      }\n    }\n\n    return updaters.length ? updaters : null;\n  }\n\n  getPickingInfo({info}) {\n    const {sortedColorBins, sortedElevationBins} = this.state;\n\n    const isPicked = info.picked && info.index > -1;\n    let object = null;\n\n    if (isPicked) {\n      const cell = this.state.layerData[info.index];\n\n      const colorValue =\n        sortedColorBins.binMap[cell.index] && sortedColorBins.binMap[cell.index].value;\n      const elevationValue =\n        sortedElevationBins.binMap[cell.index] && sortedElevationBins.binMap[cell.index].value;\n\n      object = Object.assign(\n        {\n          colorValue,\n          elevationValue\n        },\n        cell\n      );\n    }\n\n    // add bin colorValue and elevationValue to info\n    return Object.assign(info, {\n      picked: Boolean(object),\n      // override object with picked cell\n      object\n    });\n  }\n\n  getUpdateTriggers() {\n    const {dimensionUpdaters} = this.state;\n\n    // merge all dimension triggers\n    const updateTriggers = {};\n\n    for (const dimensionKey in dimensionUpdaters) {\n      updateTriggers[dimensionKey] = {};\n\n      for (const step of dimensionUpdaters[dimensionKey]) {\n        step.triggers.forEach(prop => {\n          updateTriggers[dimensionKey][prop] = this.props[prop];\n        });\n      }\n    }\n\n    return updateTriggers;\n  }\n\n  getLayerData() {\n    const {data, cellSize, getPosition} = this.props;\n    const {layerData} = pointToDensityGridData(data, cellSize, getPosition);\n\n    this.setState({layerData});\n    this.getSortedBins();\n  }\n\n  getValueDomain() {\n    this.getColorValueDomain();\n    this.getElevationValueDomain();\n  }\n\n  getSortedBins() {\n    this.getSortedColorBins();\n    this.getSortedElevationBins();\n  }\n\n  getSortedColorBins() {\n    const {getColorValue} = this.props;\n    const sortedColorBins = new BinSorter(this.state.layerData || [], getColorValue);\n\n    this.setState({sortedColorBins});\n    this.getColorValueDomain();\n  }\n\n  getSortedElevationBins() {\n    const {getElevationValue} = this.props;\n    const sortedElevationBins = new BinSorter(this.state.layerData || [], getElevationValue);\n    this.setState({sortedElevationBins});\n    this.getElevationValueDomain();\n  }\n\n  getColorValueDomain() {\n    const {lowerPercentile, upperPercentile, onSetColorDomain} = this.props;\n\n    this.state.colorValueDomain = this.state.sortedColorBins.getValueRange([\n      lowerPercentile,\n      upperPercentile\n    ]);\n\n    if (typeof onSetColorDomain === 'function') {\n      onSetColorDomain(this.state.colorValueDomain);\n    }\n\n    this.getColorScale();\n  }\n\n  getElevationValueDomain() {\n    const {elevationLowerPercentile, elevationUpperPercentile, onSetElevationDomain} = this.props;\n\n    this.state.elevationValueDomain = this.state.sortedElevationBins.getValueRange([\n      elevationLowerPercentile,\n      elevationUpperPercentile\n    ]);\n\n    if (typeof onSetElevationDomain === 'function') {\n      onSetElevationDomain(this.state.elevationValueDomain);\n    }\n\n    this.getElevationScale();\n  }\n\n  getColorScale() {\n    const {colorRange} = this.props;\n    const colorDomain = this.props.colorDomain || this.state.colorValueDomain;\n\n    this.state.colorScaleFunc = getQuantizeScale(colorDomain, colorRange);\n  }\n\n  getElevationScale() {\n    const {elevationRange} = this.props;\n    const elevationDomain = this.props.elevationDomain || this.state.elevationValueDomain;\n\n    this.state.elevationScaleFunc = getLinearScale(elevationDomain, elevationRange);\n  }\n\n  _onGetSublayerColor(cell) {\n    const {sortedColorBins, colorScaleFunc, colorValueDomain} = this.state;\n\n    const cv = sortedColorBins.binMap[cell.index] && sortedColorBins.binMap[cell.index].value;\n    const colorDomain = this.props.colorDomain || colorValueDomain;\n\n    const isColorValueInDomain = cv >= colorDomain[0] && cv <= colorDomain[colorDomain.length - 1];\n\n    // if cell value is outside domain, set alpha to 0\n    const color = isColorValueInDomain ? colorScaleFunc(cv) : [0, 0, 0, 0];\n\n    // add alpha to color if not defined in colorRange\n    color[3] = Number.isFinite(color[3]) ? color[3] : 255;\n\n    return color;\n  }\n\n  _onGetSublayerElevation(cell) {\n    const {sortedElevationBins, elevationScaleFunc, elevationValueDomain} = this.state;\n    const ev =\n      sortedElevationBins.binMap[cell.index] && sortedElevationBins.binMap[cell.index].value;\n\n    const elevationDomain = this.props.elevationDomain || elevationValueDomain;\n\n    const isElevationValueInDomain =\n      ev >= elevationDomain[0] && ev <= elevationDomain[elevationDomain.length - 1];\n\n    // if cell value is outside domain, set elevation to -1\n    return isElevationValueInDomain ? elevationScaleFunc(ev) : -1;\n  }\n\n  // for subclassing, override this method to return\n  // customized sub layer props\n  getSubLayerProps() {\n    const {elevationScale, fp64, extruded, cellSize, coverage, lightSettings} = this.props;\n\n    // return props to the sublayer constructor\n    return super.getSubLayerProps({\n      id: 'grid-cell',\n      data: this.state.layerData,\n\n      fp64,\n      cellSize,\n      coverage,\n      lightSettings,\n      elevationScale,\n      extruded,\n\n      getColor: this._onGetSublayerColor.bind(this),\n      getElevation: this._onGetSublayerElevation.bind(this),\n      updateTriggers: this.getUpdateTriggers()\n    });\n  }\n\n  // for subclassing, override this method to return\n  // customized sub layer class\n  getSubLayerClass() {\n    return GridCellLayer;\n  }\n\n  renderLayers() {\n    const SubLayerClass = this.getSubLayerClass();\n\n    return new SubLayerClass(this.getSubLayerProps());\n  }\n}\n\nGridLayer.layerName = 'GridLayer';\nGridLayer.defaultProps = defaultProps;\n"],"file":"grid-layer.js"}